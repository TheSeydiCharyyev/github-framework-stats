<svg xmlns="http://www.w3.org/2000/svg" width="{{ width + 150 }}" height="{{ height }}" viewBox="0 0 {{ width + 150 }} {{ height }}">
  <defs>
    <style>
      .title { font: 600 16px system-ui, -apple-system, sans-serif; fill: {{ theme.text_primary }}; }
      .legend-text { font: 400 11px system-ui, -apple-system, sans-serif; fill: {{ theme.text_primary }}; }
      .legend-count { font: 400 10px system-ui, -apple-system, sans-serif; fill: {{ theme.text_secondary }}; }
    </style>
  </defs>

  <rect width="100%" height="100%" fill="{{ theme.background }}" rx="8"/>

  <!-- Header -->
  <text x="{{ style.padding }}" y="{{ style.padding + 16 }}" class="title">@{{ username }}'s Tech Distribution</text>

  <!-- Pie chart -->
  {% set cx = 120 %}
  {% set cy = height // 2 + 20 %}
  {% set r = 80 %}
  {% set total = technologies|sum(attribute='count') %}

  {% if total > 0 %}
  {% set start_angle = 0 %}
  {% for tech in technologies %}
  {% set percentage = tech.count / total %}
  {% set angle = percentage * 360 %}
  {% set end_angle = start_angle + angle %}

  {% set start_rad = (start_angle - 90) * 3.14159 / 180 %}
  {% set end_rad = (end_angle - 90) * 3.14159 / 180 %}

  {% set x1 = cx + r * math.cos(start_rad) %}
  {% set y1 = cy + r * math.sin(start_rad) %}
  {% set x2 = cx + r * math.cos(end_rad) %}
  {% set y2 = cy + r * math.sin(end_rad) %}

  {% set large_arc = 1 if angle > 180 else 0 %}

  {% if technologies|length == 1 %}
  <circle cx="{{ cx }}" cy="{{ cy }}" r="{{ r }}" fill="{{ tech.color }}"/>
  {% else %}
  <path d="M {{ cx }} {{ cy }} L {{ x1 }} {{ y1 }} A {{ r }} {{ r }} 0 {{ large_arc }} 1 {{ x2 }} {{ y2 }} Z" fill="{{ tech.color }}"/>
  {% endif %}

  {% set start_angle = end_angle %}
  {% endfor %}
  {% endif %}

  <!-- Center circle for donut effect -->
  <circle cx="{{ cx }}" cy="{{ cy }}" r="40" fill="{{ theme.background }}"/>
  <text x="{{ cx }}" y="{{ cy + 5 }}" text-anchor="middle" class="title">{{ total }}</text>

  <!-- Legend -->
  {% set legend_x = 250 %}
  {% set legend_y = 60 %}
  {% for tech in technologies[:10] %}
  <g transform="translate({{ legend_x }}, {{ legend_y + loop.index0 * 22 }})">
    {% set icon_url = get_icon_url(tech.icon) %}
    {% if icon_url %}
    <image x="0" y="0" width="14" height="14" href="{{ icon_url }}"/>
    {% else %}
    <rect width="12" height="12" fill="{{ tech.color }}" rx="2"/>
    {% endif %}
    <text x="20" y="11" class="legend-text">{{ tech.name }}</text>
    <text x="140" y="11" class="legend-count">{{ tech.count }}</text>
  </g>
  {% endfor %}
</svg>
